# Deploy to staging VPS on push to main or manual trigger.
# Required GitHub Actions secrets: VPS_HOST, VPS_SSH_PRIVATE_KEY
# Optional: VPS_USER (default root), VPS_PROJECT_PATH (default VenGrow), VPS_WEB_DIR (default /var/www/staging.vengrow.net)
name: Deploy to Staging VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Staging VPS
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER || 'root' }}
      VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH || 'VenGrow' }}
      VPS_WEB_DIR: ${{ secrets.VPS_WEB_DIR || '/var/www/staging.vengrow.net' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "$VPS_HOST" ]; then
            echo "::error::VPS_HOST secret is not set. Add it in Settings â†’ Secrets and variables â†’ Actions."
            exit 1
          fi
          echo "Required secrets are set."

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to VPS
        run: |
          # Pass env vars to remote so the heredoc can use them (quoted REMOTE = no local expansion)
          ssh -o StrictHostKeyChecking=no "$VPS_USER@$VPS_HOST" \
            "REMOTE_PROJECT_PATH='$VPS_PROJECT_PATH' REMOTE_WEB_DIR='$VPS_WEB_DIR' REMOTE_BRANCH='${{ github.ref_name }}' bash -s" << 'REMOTE'
            set -e
            echo "ðŸš€ Starting deployment..."
            cd "$REMOTE_PROJECT_PATH"
            echo "ðŸ“¥ Pulling latest changes from branch: $REMOTE_BRANCH..."
            git fetch origin
            git checkout "$REMOTE_BRANCH"
            git pull origin "$REMOTE_BRANCH"
            echo "ðŸ“¦ Installing dependencies..."
            npm install
            echo "ðŸ”¨ Building project..."
            npm run build
            echo "ðŸ§¹ Cleaning web directory..."
            sudo rm -rf "$REMOTE_WEB_DIR"/*
            echo "ðŸ“‹ Copying build files..."
            sudo cp -r dist/* "$REMOTE_WEB_DIR/"
            echo "ðŸ”„ Restarting PM2 process..."
            pm2 restart ecosystem.config.cjs --only vengrow-staging --update-env
            echo "ðŸ”„ Reloading nginx..."
            sudo systemctl reload nginx
            echo "ðŸ—„ï¸ Pushing database schema..."
            npm run db:push
            echo "âœ… Deployment completed successfully!"
          REMOTE

      - name: Deployment complete
        run: echo "âœ… Staging deployment finished."
